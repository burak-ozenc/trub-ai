services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: trubai-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-trubai_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-trubai_pass}
      POSTGRES_DB: ${POSTGRES_DB:-trubai}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trubai_user -d trubai"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trubai-network

  # Node.js Backend API
  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
      target: development
    container_name: trubai-backend
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${BACKEND_PORT:-3000}
      DATABASE_URL: postgresql://trubai_user:trubai_pass@postgres:5432/trubai
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: trubai_user
      POSTGRES_PASSWORD: trubai_pass
      POSTGRES_DB: trubai
      JWT_SECRET: ${JWT_SECRET:-development-secret-change-in-production-abc123}
      AUDIO_SERVICE_URL: http://audio-service:8001
      LLM_SERVICE_URL: http://llm-service:8002
      # AWS S3 Configuration (LocalStack for local dev)
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-trubai-media-local}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-test}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-test}
      AWS_ENDPOINT_URL: ${AWS_ENDPOINT_URL}  # No default - set in .env (LocalStack or empty for real AWS)
    ports:
      - "3000:3000"
    volumes:
      - ./services/backend/src:/app/src
      - ./services/backend/package.json:/app/package.json
      - ./services/backend/data:/app/data
      - ./services/audio-service:/audio-service
      - backend-node-modules:/app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_healthy
    networks:
      - trubai-network
    command: npm run dev

  # LocalStack - Local AWS S3 emulator for development
  localstack:
    image: localstack/localstack:latest
    container_name: trubai-localstack
    environment:
      SERVICES: s3
      DEBUG: ${DEBUG:-0}
      DATA_DIR: /var/lib/localstack
      DOCKER_HOST: unix:///var/run/docker.sock
      DEFAULT_REGION: us-east-1
    ports:
      - "4566:4566"
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trubai-network

  # Python Audio Service
  audio-service:
    build:
      context: ./services/audio-service
      dockerfile: Dockerfile
    container_name: trubai-audio-service
    environment:
      PORT: ${AUDIO_SERVICE_PORT:-8001}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "8001:8001"
    volumes:
      - ./services/audio-service:/app
      - audio-service-cache:/root/.cache
    networks:
      - trubai-network
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --reload

  # Python LLM Service
  llm-service:
    build:
      context: ./services/llm-service
      dockerfile: Dockerfile
    container_name: trubai-llm-service
    env_file:
      - ./services/llm-service/.env
    environment:
      SERVICE_PORT: 8002
      SERVICE_HOST: 0.0.0.0
    ports:
      - "8002:8002"
    volumes:
      - ./services/llm-service:/app
    networks:
      - trubai-network
    command: uvicorn main:app --host 0.0.0.0 --port 8002 --reload

  # React Frontend
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
      target: development
    container_name: trubai-frontend
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}
      VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:3000}
    ports:
      - "5173:5173"
    volumes:
      - ./services/frontend/src:/app/src
      - ./services/frontend/public:/app/public
      - ./services/frontend/index.html:/app/index.html
      - ./services/frontend/package.json:/app/package.json
      - ./services/frontend/vite.config.ts:/app/vite.config.ts
      - ./services/frontend/tailwind.config.js:/app/tailwind.config.js
      - ./services/frontend/tsconfig.json:/app/tsconfig.json
      - frontend-node-modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - trubai-network
    command: npm run dev

networks:
  trubai-network:
    driver: bridge

volumes:
  postgres-data:
  backend-node-modules:
  frontend-node-modules:
  audio-service-cache:
  localstack-data:
